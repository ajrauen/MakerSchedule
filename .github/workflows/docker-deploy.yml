# .github/workflows/docker-deploy.yml
name: Deploy to VPS with Docker

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore MakeScheduleBE/MakerSchedule.sln

      - name: Build application
        run: dotnet build MakeScheduleBE/MakerSchedule.sln --configuration Release --no-restore

      - name: Publish application
        run: dotnet publish MakeScheduleBE/MakerSchedule.API/MakerSchedule.API.csproj --configuration Release --output ./publish --no-build

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r publish/* deployment/
          cp docker-compose.production.yml deployment/docker-compose.yml
          cp nginx.conf deployment/

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          timeout: 60s
          command_timeout: 30s
          script: |
            echo "SSH connection successful!"
            echo "Server info:"
            uname -a
            echo "Docker status:"
            docker --version || echo "Docker not installed"
            echo "Available space:"
            df -h

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          source: "deployment/*"
          target: "/tmp/makerschedule-deploy"
          strip_components: 1
          timeout: 120s
          command_timeout: 300s

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          timeout: 120s
          command_timeout: 600s
          script: |
            # Navigate to deployment directory
            cd /tmp/makerschedule-deploy

            # Create .env file with secrets
            cat > .env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_KEY=${{ secrets.JWT_KEY }}
            DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            EOF

            # Process nginx config with domain substitution (preserve nginx variables)
            cat > nginx.conf << 'EOF'
            events {
                worker_connections 1024;
            }

            http {
                include       /etc/nginx/mime.types;
                default_type  application/octet-stream;

                # Rate limiting
                limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

                # Upstream for API
                upstream api {
                    server makerschedule_api:5000;
                }

                # HTTP server
                server {
                    listen 80;
                    server_name ${{ secrets.DOMAIN_NAME }};

                    # Let's Encrypt challenge
                    location /.well-known/acme-challenge/ {
                        root /var/www/certbot;
                    }

                    # API proxy for HTTP (fallback until SSL is ready)
                    location / {
                        limit_req zone=api burst=20 nodelay;
                        proxy_pass http://api/;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_connect_timeout 30s;
                        proxy_send_timeout 30s;
                        proxy_read_timeout 30s;
                    }
                }
            }
            EOF

            # Create app directory and move files
            mkdir -p app
            mv *.dll *.json *.pdb *.deps.json *.runtimeconfig.json app/ 2>/dev/null || true

            # Start services without SSL first
            docker compose up -d

            # Wait for services to be ready
            echo "Waiting for services to start..."
            sleep 15

            # Check service status
            docker compose ps
            docker compose logs --tail=20

            # Test the API via HTTP first
            echo "Testing API endpoint via HTTP..."
            curl -f http://${{ secrets.DOMAIN_NAME }}/ || echo "API is starting up..."
            curl -f http://${{ secrets.DOMAIN_NAME }}/health || echo "Health check endpoint not available"

            # Show running containers
            docker ps

            # Cleanup old images (optional)
            docker image prune -f

      - name: Cleanup deployment files
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            # Keep the .env file and docker-compose.yml for manual management
            rm -rf /tmp/makerschedule-deploy/app/*
            echo "Deployment complete! Services are running in Docker containers."
            echo "Use 'docker-compose logs -f' to view logs"
            echo "Use 'docker-compose restart' to restart services"
