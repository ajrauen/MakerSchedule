---
# MakerSchedule Frontend Deployment Playbook
# Usage: ansible-playbook -i inventory/production.yml deploy-frontend.yml

- name: Deploy MakerSchedule Frontend
  hosts: all
  become: yes
  vars:
    frontend_dir: /var/www/makerschedule
    frontend_build_dir: ../MakerScheduleFE/dist
    app_user: www-data

  tasks:
    - name: Create backup of existing frontend
      command: cp -r {{ frontend_dir }} {{ frontend_dir }}.backup
      args:
        creates: "{{ frontend_dir }}.backup"
      ignore_errors: yes
      when:
        - frontend_dir is defined
        - ansible_os_family == "Debian"

    - name: Ensure frontend directory exists
      file:
        path: "{{ frontend_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    - name: Copy frontend build files
      copy:
        src: "{{ frontend_build_dir }}/"
        dest: "{{ frontend_dir }}/"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
        remote_src: yes
      when: frontend_build_dir is defined

    - name: Set proper permissions
      file:
        path: "{{ frontend_dir }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
        recurse: yes

    - name: Test nginx configuration
      command: docker exec makerschedule_nginx nginx -t
      register: nginx_test
      changed_when: false
      ignore_errors: yes
    - name: Reload nginx
      command: docker exec makerschedule_nginx nginx -s reload
      when: nginx_test.rc == 0

    - name: Verify deployment
      uri:
        url: "https://{{ domain_name }}/"
        status_code: 200
      register: frontend_check
      retries: 3
      delay: 2

    - name: Display deployment result
      debug:
        msg: "Frontend deployed successfully! Visit https://{{ domain_name }}"
      when: frontend_check.status == 200

    - name: Rollback on failure
      block:
        - name: Restore backup
          command: rsync -a --delete {{ frontend_dir }}.backup/ {{ frontend_dir }}/
          when: frontend_dir + '.backup' is directory

        - name: Fail deployment
          fail:
            msg: "Frontend deployment failed! Rolled back to previous version."
      when: frontend_check.status != 200
